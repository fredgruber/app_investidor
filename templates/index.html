<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador DCA Bitcoin vs Tradicional</title>

    <!-- PWA / Mobile Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="InvestSim">
    <meta name="theme-color" content="#0d1117">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/app_icon.png">

    <link rel="stylesheet" href="/static/style.css">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(reg => console.log('SW Registered!', reg.scope))
                    .catch(err => console.log('SW Err:', err));
            });
        }
    </script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Simulador de Investimentos DCA</h1>
            <div class="subtitle">Compare a estrat√©gia Dollar-Cost Averaging em Bitcoin contra Lump Sum em Ouro e S&P
                500</div>
        </header>

        <section class="card">
            <form action="/simulate" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="initial_amount">Aporte Inicial (USD)</label>
                        <input type="number" id="initial_amount" name="initial_amount" value="{{.InitialAmount}}"
                            min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="amount">Aporte Recorrente (USD)</label>
                        <input type="number" id="amount" name="amount" value="{{.Amount}}" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="frequency">Frequ√™ncia</label>
                        <select id="frequency" name="frequency">
                            <option value="daily" {{if eq .Frequency "daily" }}selected{{end}}>Di√°rio</option>
                            <option value="weekly" {{if eq .Frequency "weekly" }}selected{{end}}>Semanal</option>
                            <option value="monthly" {{if eq .Frequency "monthly" }}selected{{end}}>Mensal</option>
                        </select>
                    </div>

                    <div style="grid-column: 1 / -1; display: flex; gap: 1.5rem; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="startDate">Data de In√≠cio</label>
                            <input type="date" id="startDate" name="startDate" value="{{.StartDate}}" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="endDate">Data Final</label>
                            <input type="date" id="endDate" name="endDate" value="{{.EndDate}}" required>
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="use_native" value="true" {{if .UseNative}}checked{{end}}>
                            <span>Ignorar C√¢mbio (Moeda Original)</span>
                        </label>
                        <small style="color: #8b949e; display: block; margin-top: 4px; font-size: 0.8em;">
                            √ötil para ver o retorno nominal de Randa Fixa BR sem converter para D√≥lar.
                        </small>
                    </div>
                </div>

                <div class="assets-section">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Sele√ß√£o de Ativos</h3>
                        <div class="selection-controls">
                            <button type="button" onclick="toggleColumn('dca_assets', true)" class="btn-small">Todos
                                DCA</button>
                            <button type="button" onclick="toggleColumn('ls_assets', true)" class="btn-small">Todos
                                LS</button>
                            <button type="button" onclick="clearAll()" class="btn-small outline">Limpar Tudo</button>
                        </div>
                    </div>

                    <div class="assets-table-container">
                        <table class="assets-selection-table">
                            <thead>
                                <tr>
                                    <th>Ativo</th>
                                    <th class="text-center" title="Comprar recorrente">DCA</th>
                                    <th class="text-center" title="Investimento √∫nico inicial">Lump Sum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .Assets}}
                                <tr>
                                    <td>
                                        <span class="asset-name-row">{{.Name}}</span>
                                        <span class="asset-cat">{{.Category}}</span>
                                    </td>
                                    <td class="text-center">
                                        <label class="switch">
                                            <input type="checkbox" name="dca_assets" value="{{.Symbol}}" {{if index
                                                $.SelectedDCA .Symbol}}checked{{end}}>
                                            <span class="slider round"></span>
                                        </label>
                                    </td>
                                    <td class="text-center">
                                        <label class="switch">
                                            <input type="checkbox" name="ls_assets" value="{{.Symbol}}" {{if index
                                                $.SelectedLS .Symbol}}checked{{end}}>
                                            <span class="slider round"></span>
                                        </label>
                                    </td>
                                </tr>
                                {{end}}
                                <!-- Linha Personalizada -->
                                <tr style="background: rgba(255, 255, 255, 0.05); border-top: 2px solid #30363d;">
                                    <td>
                                        <label
                                            style="display:block; font-size: 0.8em; color: #8b949e; margin-bottom: 2px;">
                                            Outros Ativos (ex: WEGE3.SA)
                                        </label>

                                        <!-- Container do Widget de Tags -->
                                        <div class="tag-input-container">
                                            <div id="tags-list" class="tags-list">
                                                <!-- Tags ser√£o inseridas aqui via JS -->
                                            </div>
                                            <div style="display: flex; gap: 5px;">
                                                <input type="text" id="tag-input" placeholder="Adicionar ativo..."
                                                    onkeydown="handleTagInputKey(event)">
                                                <button type="button" onclick="addTag()" class="btn-small"
                                                    style="width: auto; padding: 0.2rem 0.8rem;">+</button>
                                            </div>
                                            <!-- Container escondido para os inputs do form -->
                                            <div id="hidden-inputs"></div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <label class="switch">
                                            <input type="checkbox" name="custom_dca" {{if .CustomDCA}}checked{{end}}>
                                            <span class="slider round"></span>
                                        </label>
                                    </td>
                                    <td class="text-center">
                                        <label class="switch">
                                            <input type="checkbox" name="custom_ls" {{if .CustomLS}}checked{{end}}>
                                            <span class="slider round"></span>
                                        </label>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Se√ß√£o COE -->
                <div class="assets-section"
                    style="margin-top: 1.5rem; border: 1px solid #30363d; padding: 1rem; border-radius: 8px; background: rgba(22, 199, 132, 0.05);">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="margin:0; color: #16C784;">Simular COEs (M√∫ltiplos)</h3>
                        <label class="switch">
                            <input type="checkbox" name="coe_enabled" {{if .ShowCOE}}checked{{end}}>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="form-grid" style="align-items: end;">
                        <div class="form-group">
                            <label for="new_coe_asset">Ativo Objeto</label>
                            <input type="text" id="new_coe_asset" list="coe_suggestions"
                                placeholder="Ex: PETR4.SA ou Selecione">
                            <datalist id="coe_suggestions">
                                <option value="BIG_TECHS">Big Techs (Nasdaq 100)</option>
                                <option value="IPCA">IPCA + (IMAB11)</option>
                                <option value="SP500">S&P 500</option>
                                <option value="DOLAR">D√≥lar</option>
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label>Regras</label>
                            <label
                                style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-color); height: 42px;">
                                <input type="checkbox" id="new_coe_protected" checked>
                                Capital Protegido
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="new_coe_participation">Part. Alta (%)</label>
                            <input type="number" id="new_coe_participation" value="100" min="1" step="1">
                        </div>
                        <div class="form-group">
                            <label for="new_coe_cap">Limitador (%)</label>
                            <input type="number" id="new_coe_cap" value="50" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <button type="button" onclick="addCOE()" class="btn-small"
                                style="height: 42px; background: #16C784; width: 100%; justify-content: center;">Adicionar</button>
                        </div>
                    </div>

                    <!-- Lista de COEs Adicionados -->
                    <div id="coe-list" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- JS vai popular aqui -->
                    </div>
                    <div id="coe-hidden-inputs"></div>

                    <small style="color: #8b949e; display: block; margin-top: 10px;">
                        * Adicione os COEs √† lista acima antes de simular.
                    </small>
                </div>

                <button type="submit" style="margin-top: 1.5rem;">Simular Compara√ß√£o</button>
            </form>
        </section>

        {{if .Error}}
        <div class="card" style="border-color: #ea3943;">
            <p style="color: #ea3943;">{{.Error}}</p>
        </div>
        {{end}}

        {{if .Results}}
        <section class="card">
            <h2>Resultados</h2>
            <table>
                <thead>
                    <tr>
                        <th>Estrat√©gia</th>
                        <th>Total Investido</th>
                        <th>Valor Final</th>
                        <th>Retorno %</th>
                        <th>Vantagem vs DCA</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Results}}
                    <tr>
                        <td>{{.StrategyName}}</td>
                        <td>${{printf "%.2f" .TotalInvested}}</td>
                        <td>${{printf "%.2f" .FinalValue}}</td>
                        <td class="{{if ge .ReturnPercent 0.0}}positive{{else}}negative{{end}}">{{printf "%.2f"
                            .ReturnPercent}}%</td>
                        <td>
                            <!-- Vantagem visual calculada no backend no futuro? -->
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>

            <div class="best-strategy">
                üèÜ Melhor Estrat√©gia: {{.BestStrategy}}
            </div>
        </section>

        <section class="insights">
            <div class="insight-card">
                <h3>üí° Por que DCA?</h3>
                <p>O Dollar-Cost Averaging (DCA) suaviza a entrada no mercado. Ao comprar quantias fixas regularmente,
                    voc√™ compra mais Bitcoin quando o pre√ßo cai e menos quando sobe, reduzindo o pre√ßo m√©dio por moeda e
                    eliminando o estresse de tentar acertar o "fundo" do mercado (timing).</p>
            </div>

            <div class="insight-card">
                <h3>üìä Volatilidade vs Estabilidade</h3>
                <p>O Bitcoin tende a ter alta volatilidade. A Renda Fixa Brasileira oferece seguran√ßa nominal, mas sofre
                    com a desvaloriza√ß√£o cambial (D√≥lar). A√ß√µes Tech americanas oferecem alto crescimento. Comparar
                    todos ajuda a diversificar.</p>
            </div>
        </section>
        {{end}}
    </div>

    <script>
        // Dados iniciais vindos do servidor
        const initialCustomTickers = {{.CustomTickersJSON }};
        const initialCOEs = {{.COEsJSON }};

        function toggleColumn(name, checked) {
            const checkboxes = document.getElementsByName(name);
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = checked;
            }
        }

        function clearAll() {
            toggleColumn('dca_assets', false);
            toggleColumn('ls_assets', false);
        }

        // --- Tag Input Logic ---
        const tagsList = document.getElementById('tags-list');
        const tagInput = document.getElementById('tag-input');
        const hiddenInputs = document.getElementById('hidden-inputs');
        let tags = [];

        function renderTags() {
            tagsList.innerHTML = '';
            hiddenInputs.innerHTML = '';

            tags.forEach((tag, index) => {
                // Render Visual Tag
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.innerHTML = `
                    ${tag}
                    <span class="remove-tag" onclick="removeTag(${index})">&times;</span>
                `;
                tagsList.appendChild(tagEl);

                // Render Hidden Input
                const inputEl = document.createElement('input');
                inputEl.type = 'hidden';
                inputEl.name = 'custom_ticker';
                inputEl.value = tag;
                hiddenInputs.appendChild(inputEl);
            });
        }

        function addTag() {
            const val = tagInput.value.trim().toUpperCase();
            if (val && !tags.includes(val)) {
                tags.push(val);
                tagInput.value = '';
                renderTags();
            }
            tagInput.focus();
        }

        function removeTag(index) {
            tags.splice(index, 1);
            renderTags();
        }

        function handleTagInputKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag();
            }
        }

        // Initialize
        if (initialCustomTickers && Array.isArray(initialCustomTickers)) {
            tags = initialCustomTickers;
            renderTags();
        }

        // --- COE List Logic ---
        const coeListEl = document.getElementById('coe-list');
        const coeHiddenEl = document.getElementById('coe-hidden-inputs');
        let coes = [];

        function renderCOEs() {
            coeListEl.innerHTML = '';
            coeHiddenEl.innerHTML = '';

            coes.forEach((c, index) => {
                // Visual
                const row = document.createElement('div');
                row.style.cssText = "display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; border: 1px solid #30363d;";

                let assetName = c.Asset; // Mapping for display could be improved
                if (assetName == 'BIG_TECHS') assetName = "Big Techs";
                if (assetName == 'DOLAR') assetName = "D√≥lar";

                row.innerHTML = `
                    <div style="font-size: 0.9em;">
                        <strong>${assetName}</strong> | 
                        ${c.Protected ? 'üõ°Ô∏è Protegido' : '‚ö†Ô∏è Sem Prot.'} | 
                        Part: ${c.Participation}% | Cap: ${c.Cap}%
                    </div>
                    <button type="button" onclick="removeCOE(${index})" style="background:none; border:none; color: #ea3943; font-size: 1.2em; padding: 0; width: auto; cursor: pointer;">&times;</button>
                `;
                coeListEl.appendChild(row);

                // Hidden Inputs
                // Note: We create separate inputs for each array strategy
                coeHiddenEl.innerHTML += `
                    <input type="hidden" name="coe_asset" value="${c.Asset}">
                    <input type="hidden" name="coe_protected" value="${c.Protected}">
                    <input type="hidden" name="coe_participation" value="${c.Participation}">
                    <input type="hidden" name="coe_cap" value="${c.Cap}">
                `;
            });
        }

        function addCOE() {
            const asset = document.getElementById('new_coe_asset').value;
            const protected = document.getElementById('new_coe_protected').checked;
            const participation = document.getElementById('new_coe_participation').value;
            const cap = document.getElementById('new_coe_cap').value;

            coes.push({
                Asset: asset,
                Protected: protected,
                Participation: participation,
                Cap: cap
            });
            renderCOEs();
        }

        function removeCOE(index) {
            coes.splice(index, 1);
            renderCOEs();
        }

        if (initialCOEs && Array.isArray(initialCOEs)) {
            coes = initialCOEs;
            // Map keys from Go struct (Capitalized) to JS (Capitalized as handled in backend JSON)
            // Go JSON marshal keeps User-Defined keys usually, so it should match "Asset", "Protected" etc.
            renderCOEs();
        }
    </script>
</body>

</html>